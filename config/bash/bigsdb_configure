#!/bin/bash

# save environment variables
export BIGS_ENVIRONMENT=/setup/bigsdb.env
mkdir -p /setup/environment
set | grep '^BIGS_\|^POSTGRES_' > ${BIGS_ENVIRONMENT} 

# create log file and set permissions
touch /var/log/bigsdb.log
chown www-data /var/log/bigsdb.log

# set rights and permissions of directories
chown www-data:www-data -R /var/www
chmod a+w /var/log

# apache config: disable default site configs
# a2dissite 000-default # <- this line is necessary, if 000-default.conf is not present in /etc/apache2/sites-available/
# other defaults
for i in $(ls /etc/apache2/sites-available/*default*); do
   default_confx=$(basename $i)
   a2dissite ${default_confx%.conf}
done

# apache config: enable all other
for i in $(ls /etc/apache2/sites-available/ -I "*default*"); do
   site_confx=$(basename $i)
   a2ensite ${site_confx%.conf}
done

# ToDo: create user bigsdb
useradd -s /bin/bash bigsdb

# crontab
echo -e "* * * * *\tbigsdb\txvfb-run -a /usr/local/bin/bigsjobs" >> /etc/crontab
echo -e "05 * * * *\tbigsdb\t/usr/local/bin/sync_user_dbase_users.pl --user-database pubmlst_bigsdb_users" >> /etc/crontab

# jobs logs
touch /var/log/bigsdb_jobs.log
chown bigsdb /var/log/bigsdb_jobs.log

# modify users
usermod -a -G www-data bigsdb
usermod -a -G bigsdb www-data

# submissions
touch /var/submissions
chown www-data:www-data /var/submissions
chmod 775 /var/submissions
ln -s /var/submissions /var/www

# apache2: enable cgi
a2enmod cgi

# start apache2 (as bigsdb)?
apache2ctl -DFOREGROUND
